{% extends "base_dashboard.html" %}
{% load static %}

{% block title %}Detalle de Orden #{{ solicitud.pk }}{% endblock %}

{% block dashboard_content %}
<div class="card shadow-lg">
    <div class="card-header bg-indigo-600 text-white">
        <h3 class="mb-0">Detalle de Orden de Trabajo #{{ solicitud.pk }}</h3>
    </div>
    <div class="card-body">
        
        <div class="row mb-4">
            <div class="col-md-6">
                <h5 class="text-primary">Información General de la Solicitud</h5>
                <hr>
                <p><strong>Estado Actual:</strong> 
                    <span class="px-2 py-1 inline-flex text-sm leading-5 font-semibold rounded-full 
                        {% if solicitud.estado == 'PENDIENTE' %} bg-warning text-dark
                        {% elif solicitud.estado == 'APROBADA' %} bg-primary text-white
                        {% elif solicitud.estado == 'RECHAZADA' %} bg-danger text-white
                        {% else %} bg-success text-white {% endif %}">
                        {{ solicitud.get_estado_display }}
                    </span>
                </p>
                <p><strong>Fecha Solicitud:</strong> {{ solicitud.fecha_solicitud|date:"d M Y H:i" }}</p>
                <p><strong>Maquinaria/Activo:</strong> {{ solicitud.maquinaria }}</p>
                <p><strong>Ubicación:</strong> {{ solicitud.ubicacion }}</p>
                <p><strong>Descripción:</strong> {{ solicitud.descripcion }}</p>
            </div>

            {% if inspeccion %}
            <div class="col-md-6 border-start">
                <h5 class="text-success">Detalles de la Inspección Asignada</h5>
                <hr>
                <p><strong>Nombre Inspección:</strong> {{ inspeccion.nombre_inspeccion }}</p>
                <p><strong>Técnico Asignado:</strong> {{ inspeccion.tecnico.first_name }} {{ inspeccion.tecnico.last_name }}</p>
                <p><strong>Fecha Inicio:</strong> {{ inspeccion.fecha_creacion|date:"d M Y" }}</p>
                {% if inspeccion.estado == 'COMPLETADA' %}
                    <p><strong>Fecha Finalización:</strong> {{ inspeccion.fecha_finalizacion|date:"d M Y H:i" }}</p>
                    <p><strong>Comentarios Finales:</strong> {{ inspeccion.comentarios_generales|default:"Sin comentarios." }}</p>
                {% else %}
                    <p class="text-warning">**Inspección en curso o pendiente de finalizar por el técnico.**</p>
                {% endif %}
            </div>
            {% elif solicitud.estado == 'RECHAZADA' %}
            <div class="col-md-6 border-start">
                <h5 class="text-danger">Motivo del Rechazo</h5>
                <hr>
                <p>{{ solicitud.motivo_rechazo }}</p>
            </div>
            {% endif %}
        </div>

        
        {% if tareas %}
        <h5 class="text-info mt-4">Checklist de Tareas Realizadas</h5>
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="bg-light">
                    <tr>
                        <th style="width: 5%;">#</th>
                        <th>Descripción de la Tarea</th>
                        <th style="width: 15%;">Estado</th>
                        <th style="width: 30%;">Observación del Técnico</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tarea in tareas %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ tarea.descripcion }}</td>
                        <td>
                            {% if tarea.estado == 'OK' %} 
                                <span class="badge bg-success">Completado OK</span>
                            {% elif tarea.estado == 'FAIL' %} 
                                <span class="badge bg-danger">Fallo Reportado</span>
                            {% else %}
                                <span class="badge bg-secondary">Pendiente/N/A</span>
                            {% endif %}
                        </td>
                        <td>{{ tarea.observacion|default:"(Sin observaciones)" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
        
    </div>
    <div class="card-footer d-flex justify-content-between">
        <a href="{% url 'dashboard_cliente' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> Volver a Mis Órdenes
        </a>
        
        {# Botón de Descarga del Acta (Solo si está COMPLETADA) #}
        {% if inspeccion and inspeccion.estado == 'COMPLETADA' %}
        <a href="{% url 'descargar_acta' inspeccion.pk %}" class="btn btn-success">
            <i class="fas fa-file-pdf me-1"></i> Descargar Acta
        </a>
        {% endif %}
    </div>
</div>
{% endblock dashboard_content %}