{% extends "base_dashboard.html" %} 
{% load static %}

{% block title %}Dashboard Cliente | Optifire{% endblock %}

{# -------------------------------------------------------------------------------------------------- #}
{# 1. BLOQUE DEL MEN칔 LATERAL (SIDEBAR) - Opciones espec칤ficas del Cliente #}
{# -------------------------------------------------------------------------------------------------- #}
{% block dashboard_menu %}
<ul class="nav flex-column">
    {# A칌ADIDO: Mi Perfil #}
    <li class="nav-item">
        {# Usamos la ruta existente 'editar_perfil' #}
        <a class="nav-link text-white" href="{% url 'editar_perfil' %}">
            <i class="fas fa-user-circle me-2"></i> Mi Perfil
        </a>
    </li>
    
    {# Mis Solicitudes (P치gina Actual) #}
    <li class="nav-item">
        {# Asegurando color blanco para los enlaces en el fondo oscuro #}
        <a class="nav-link text-info active" href="{% url 'dashboard_cliente' %}"> 
            <i class="fas fa-list-alt me-2"></i> Mis Ordenes
        </a>
    </li>
    
    {# Solicitar Inspeccion / Orden de Trabajo (Unificado) #}
    <li class="nav-item">
        <a class="nav-link text-white" href="{% url 'solicitar_inspeccion' %}">
            <i class="fas fa-plus-circle me-2"></i> Generar Orden de trabajo
        </a>
    </li>
    
    {# Salir (Deslogearse) #}
    <li class="nav-item">
        <a class="nav-link text-danger" href="{% url 'logout' %}">
            <i class="fas fa-sign-out-alt me-2"></i> Salir
        </a>
    </li>
</ul>
{% endblock dashboard_menu %}

---

{# -------------------------------------------------------------------------------------------------- #}
{# 2. BLOQUE DE CONTENIDO PRINCIPAL - Tabla de solicitudes #}
{# -------------------------------------------------------------------------------------------------- #}
{% block dashboard_content %}

    <h1 class="mb-4 text-info"><i class="fas fa-desktop me-2"></i> Panel del Cliente</h1>
    <p class="mb-4 text-white">
        Bienvenido, <span class="font-weight-bold">{{ request.user.first_name|default:request.user.username|title }}</span>. Aqu칤 puedes gestionar tus 칍rdenes de trabajo.
    </p>
    
    <div class="card shadow mt-4 optifire-dark-bg border border-warning">
        <div class="card-body">
            
            <h3 class="h4 font-weight-bold text-white mb-4">Mis Ordenes</h3>

            {# Mensajes de 칠xito/error #}
            {% if messages %}
                {% for message in messages %}
                    {# Usamos alert-{{ message.tags }} que mapea 'success', 'warning', 'error' a clases Bootstrap #}
                    <div class="alert alert-{{ message.tags }} text-dark">{{ message }}</div>
                {% endfor %}
            {% endif %}

            {% if solicitudes %}
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0 border-warning"> 
                        <thead>
                            <tr>
                                <th scope="col" class="border-warning">ID</th>
                                <th scope="col" class="border-warning">Direcci칩n</th>
                                <th scope="col" class="border-warning">Maquinaria</th>
                                <th scope="col" class="border-warning">Estado</th>
                                <th scope="col" class="border-warning">Fecha</th>
                                <th scope="col" class="border-warning">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for solicitud in solicitudes %}
                            <tr>
                                <td class="align-middle">{{ solicitud.id }}</td>
                                <td class="align-middle">{{ solicitud.direccion }}</td>
                                <td class="align-middle">{{ solicitud.maquinaria|truncatechars:30 }}</td>
                                <td class="align-middle">
                                    {# 游댠 L칩gica de colores de badge ACTUALIZADA con 'COTIZANDO' 游댠 #}
                                    <span class="badge 
                                        {% if solicitud.estado == 'PENDIENTE' %} bg-warning text-dark
                                        {% elif solicitud.estado == 'COTIZANDO' %} bg-info text-white
                                        {% elif solicitud.estado == 'APROBADA' or solicitud.estado == 'ASIGNADA' or solicitud.estado == 'EN_CURSO' %} bg-primary text-white
                                        {% elif solicitud.estado == 'RECHAZADA' %} bg-danger text-white
                                        {% elif solicitud.estado == 'ANULADA' %} bg-secondary text-white 
                                        {% elif solicitud.estado == 'COMPLETADA' %} bg-success text-white 
                                        {% else %} bg-light text-dark 
                                        {% endif %}">
                                        {{ solicitud.get_estado_display }}
                                    </span>
                                </td>
                                <td class="align-middle">{{ solicitud.fecha_solicitud|date:"d M Y" }}</td>
                                <td class="align-middle">
                                    {# 游댠 L칍GICA DE ACCIONES ACTUALIZADA 游댠 #}
                                    {% if solicitud.estado == 'PENDIENTE' %}
                                        <a href="{% url 'anular_solicitud' solicitud.pk %}" 
                                            class="btn btn-sm btn-danger" 
                                            onclick="return confirm('쯉eguro que quieres anular esta solicitud pendiente? Esta acci칩n no se puede revertir.');"
                                            title="Anular la orden de trabajo">
                                            Anular
                                        </a>
                                        
                                    {% elif solicitud.estado == 'COTIZANDO' %}
                                        {# Redirigimos al cliente a la nueva vista para aceptar/rechazar #}
                                        <a href="{% url 'aceptar_cotizacion_cliente' solicitud.pk %}" 
                                            class="btn btn-sm btn-warning text-dark" 
                                            title="Revisar y gestionar la cotizaci칩n">
                                            <i class="fas fa-hand-holding-usd"></i> Cotizar
                                        </a>

                                    {% elif solicitud.estado == 'ANULADA' %}
                                        <span class="text-secondary">Anulada</span>
                                        
                                    {% elif solicitud.estado != 'RECHAZADA' %}
                                        {# Muestra Ver detalle si fue aprobada/asignada/en curso/completada #}
                                        <a href="{% url 'detalle_orden' solicitud.pk %}" class="btn btn-sm btn-info text-white" title="Ver Detalles y Descargar Acta">
                                            <i class="fas fa-eye"></i> Ver detalle
                                        </a>
                                        
                                    {% else %}
                                        <span class="text-muted">Rechazada</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                {# Mensaje de no solicitudes #}
                <div class="alert alert-info">
                    A칰n no has realizado ninguna solicitud. <a href="{% url 'solicitar_inspeccion' %}" class="alert-link">Haz clic aqu칤 para solicitar una orden de trabajo.</a>
                </div>
            {% endif %}
        </div>
    </div>

{% endblock dashboard_content %}