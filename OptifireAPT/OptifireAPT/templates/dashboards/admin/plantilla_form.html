{% extends 'base.html' %}

{% load crispy_forms_tags %}

{% block title %}
    {% if form.instance.pk %}Editar Plantilla: {{ form.instance.nombre }}{% else %}Crear Nueva Plantilla{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="mb-4">
        <h2>
            {% if form.instance.pk %}
                <i class="fas fa-edit"></i> Editar Plantilla: {{ form.instance.nombre }}
            {% else %}
                <i class="fas fa-file-alt"></i> Crear Nueva Plantilla
            {% endif %}
        </h2>
        <p class="text-muted">Defina el nombre, descripción y las tareas que componen esta plantilla de inspección.</p>
    </div>

    <div class="card shadow">
        <div class="card-body">
            <form method="post" id="plantilla-form">
                {% csrf_token %}
                
                {# Renderiza los campos del modelo principal (PlantillaInspeccion) #}
                {{ form.nombre|as_crispy_field }}
                {{ form.descripcion|as_crispy_field }}

                {# El Div con css_id='formset-container' está en el layout del formulario principal, pero lo replicamos por si acaso #}

                <div class="card mt-3">
                    <div class="card-header bg-secondary text-white">Tareas de la Plantilla</div>
                    <div class="card-body">
                        {# Formset management form y los campos ocultos #}
                        {{ formset.management_form }}
                        
                        {# Aquí se renderizarán los formularios de TareaPlantilla #}
                        <div id="formset-container">
                            {% for form_tarea in formset %}
                                <div class="form-row formset-row border-bottom mb-2 p-2" id="row-{{ forloop.counter0 }}">
                                    {{ form_tarea.id }}
                                    <div class="col-10">
                                        {{ form_tarea.descripcion|as_crispy_field }}
                                    </div>
                                    <div class="col-2 d-flex align-items-center">
                                        {# Si el formulario es de una instancia existente, usamos un campo oculto para el borrado lógico #}
                                        {% if form_tarea.instance.pk %}
                                            {{ form_tarea.DELETE }}
                                            <button type="button" class="btn btn-sm btn-danger remove-row-existing" data-form-id="{{ forloop.counter0 }}">
                                                <i class="fas fa-minus-circle"></i> Eliminar
                                            </button>
                                        {% else %}
                                            <button type="button" class="btn btn-sm btn-danger remove-row-new" data-form-id="{{ forloop.counter0 }}">
                                                <i class="fas fa-minus-circle"></i> Eliminar
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                        <button type="button" class="btn btn-outline-primary mt-3" id="add-row">
                            <i class="fas fa-plus"></i> Agregar Tarea
                        </button>
                    </div>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Plantilla
                    </button>
                    <a href="{% url 'plantilla_list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const formsetContainer = document.getElementById('formset-container');
        const addButton = document.getElementById('add-row');
        const totalForms = document.querySelector('#id_{{ formset.prefix }}-TOTAL_FORMS');

        // Esta función clona el último formulario o un formulario vacío predefinido
        function getNewForm(index) {
            // Este es un template HTML con '__prefix__' para que Django lo reemplace
            let template = `
            <div class="form-row formset-row border-bottom mb-2 p-2" id="row-${index}">
                <input type="hidden" name="{{ formset.prefix }}-${index}-id" id="id_{{ formset.prefix }}-${index}-id" />
                <div class="col-10">
                    <div id="div_id_{{ formset.prefix }}-${index}-descripcion" class="form-group">
                        <textarea name="{{ formset.prefix }}-${index}-descripcion" cols="40" rows="1" class="form-control" id="id_{{ formset.prefix }}-${index}-descripcion" placeholder="Descripción de la Tarea"></textarea>
                    </div>
                </div>
                <div class="col-2 d-flex align-items-center">
                    <button type="button" class="btn btn-sm btn-danger remove-row-new" data-form-id="${index}">
                        <i class="fas fa-minus-circle"></i> Eliminar
                    </button>
                </div>
            </div>
            `;
            return template;
        }

        // Manejar el botón de agregar
        addButton.addEventListener('click', function() {
            const newIndex = parseInt(totalForms.value);
            const newForm = getNewForm(newIndex);
            formsetContainer.insertAdjacentHTML('beforeend', newForm);
            
            // Actualizar el contador TOTAL_FORMS
            totalForms.value = newIndex + 1;

            // Re-bindear el evento de eliminar
            bindRemoveEvents();
        });

        // Manejar el botón de eliminar
        function bindRemoveEvents() {
            // Eliminar fila nueva (simplemente la remueve del DOM)
            document.querySelectorAll('.remove-row-new').forEach(button => {
                 button.onclick = function() {
                    this.closest('.formset-row').remove();
                };
            });

            // Eliminar fila existente (marca el campo DELETE oculto)
            document.querySelectorAll('.remove-row-existing').forEach(button => {
                button.onclick = function() {
                    const rowElement = this.closest('.formset-row');
                    const index = rowElement.id.split('-')[1];
                    
                    const deleteInput = document.querySelector(`#id_{{ formset.prefix }}-${index}-DELETE`);
                    if (deleteInput) {
                        deleteInput.checked = true; // Marcar para eliminación
                        rowElement.style.display = 'none'; // Ocultar
                    }
                };
            });
        }
        
        bindRemoveEvents();
    });
</script>
{% endblock %}