{% extends "base_dashboard.html" %}
{% load static %}

{% block title %}Gestionar Orden #{{ solicitud.id }} | Optifire{% endblock %}

{% block dashboard_menu %}
    {% include "includes/admin_menu.html" %} 
{% endblock dashboard_menu %}

{% block dashboard_content %}

    <h1 class="text-white mb-4"><i class="fas fa-clipboard-check me-2"></i> Gestionar Orden #{{ solicitud.id }}</h1>
    <a href="{% url 'dashboard_administrador' %}" class="btn btn-sm btn-outline-warning mb-4">
        <i class="fas fa-arrow-left me-1"></i> Volver al Dashboard
    </a>

    {# Mostrar Mensajes (xito/Error) #}
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} text-dark">{{ message }}</div>
        {% endfor %}
    {% endif %}

    {# ---------------------------------------------------------------- #}
    {# DETALLES DE LA SOLICITUD #}
    {# ---------------------------------------------------------------- #}
    <div class="card bg-dark-subtle border-warning mb-4 shadow-sm">
        <div class="card-header bg-warning text-dark fw-bold">Detalles de la Solicitud del Cliente</div>
        <div class="card-body text-white">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Cliente:</strong> {{ solicitud.cliente.get_full_name|default:solicitud.cliente.username }}</p>
                    <p><strong>Direcci贸n:</strong> {{ solicitud.direccion }}</p>
                    <p><strong>Tel茅fono:</strong> {{ solicitud.telefono }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Maquinaria/Servicio:</strong> {{ solicitud.maquinaria }}</p>
                    <p><strong>Fecha Solicitud:</strong> {{ solicitud.fecha_solicitud|date:"d/m/Y H:i" }}</p>
                    <p>
                        <strong>Estado Actual:</strong> 
                        <span class="badge 
                            {% if solicitud.estado == 'PENDIENTE' %} bg-warning text-dark
                            {% elif solicitud.estado == 'COTIZANDO' %} bg-info text-white
                            {% elif solicitud.estado == 'APROBADA' or solicitud.estado == 'ASIGNADA' %} bg-success text-white
                            {% elif solicitud.estado == 'RECHAZADA' %} bg-danger text-white
                            {% else %} bg-secondary text-white 
                            {% endif %}">
                            {{ solicitud.get_estado_display }}
                        </span>
                    </p>
                    {% if solicitud.estado == 'COTIZANDO' or solicitud.monto_cotizacion %}
                        <p><strong>Monto Cotizado:</strong> <span class="text-info">${{ solicitud.monto_cotizacion|floatformat:0 }} CLP</span></p>
                        {% if solicitud.detalle_cotizacion %}<p class="small text-muted">Detalle: {{ solicitud.detalle_cotizacion }}</p>{% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# ---------------------------------------------------------------- #}
    {# ACCIONES DEL ADMINISTRADOR - SEGN EL ESTADO DE LA SOLICITUD #}
    {# ---------------------------------------------------------------- #}

    {% if solicitud.estado == 'PENDIENTE' %}
        <div class="row mt-4">
            
            {# ========================================================== #}
            {# 1. ENVIAR COTIZACIN Y PRE-ASIGNAR (A la espera de cliente) #}
            {# ========================================================== #}
            <div class="col-lg-6 mb-4">
                <div class="card bg-dark-subtle border-info shadow-lg h-100">
                    <div class="card-header bg-info text-white fw-bold">
                        <i class="fas fa-hand-holding-usd me-1"></i> 1. Crear Cotizaci贸n y Pre-Asignar
                    </div>
                    <div class="card-body text-white">
                        {#  TEXTO CORREGIDO  #}
                        <p>Se enviar谩 la cotizaci贸n al cliente y la solicitud pasar谩 a estado **COTIZANDO** (en espera de la aprobaci贸n del cliente). Una vez aceptada, se crea la Orden y se le asigna al t茅cnico pre-seleccionado.</p>
                        <form method="POST">
                            {% csrf_token %}
                            {# ACCIN PARA VIEWS.PY  CAMBIADA A 'enviar_cotizacion_espera'  #}
                            <input type="hidden" name="action" value="enviar_cotizacion_espera"> 

                            <h6 class="text-warning border-bottom pb-1">Detalles de la Orden</h6>
                            <div class="mb-3">
                                <label for="nombre_inspeccion" class="form-label">Nombre de la Orden</label>
                                <input type="text" class="form-control" id="nombre_inspeccion" name="nombre_inspeccion" value="Orden {{ solicitud.id }} - {{ solicitud.maquinaria }}" required>
                            </div>
                            
                            <h6 class="text-success border-bottom pb-1 mt-4">Detalles de Pre-Asignaci贸n</h6>
                            <div class="mb-3">
                                <label for="tecnico" class="form-label">Asignar T茅cnico</label>
                                <select class="form-select" id="tecnico" name="tecnico" required>
                                    <option value="">Selecciona un T茅cnico</option>
                                    {% for tecnico in tecnicos %}
                                        <option value="{{ tecnico.id }}">{{ tecnico.username }} ({{ tecnico.get_full_name|default:"Sin Nombre" }})</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="plantilla" class="form-label">Seleccionar Plantilla</label>
                                <select class="form-select" id="plantilla" name="plantilla" required>
                                    <option value="">Selecciona una Plantilla</option>
                                    {% for plantilla in plantillas %}
                                        <option value="{{ plantilla.id }}">{{ plantilla.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="fecha_realizacion" class="form-label">Fecha Programada (Tentativa)</label>
                                <input type="date" class="form-control" id="fecha_realizacion" name="fecha_realizacion" required>
                            </div>
                            
                            <h6 class="text-danger border-bottom pb-1 mt-4">Detalles de Costo (Obligatorio)</h6>
                            <div class="mb-3">
                                <label for="monto_cotizacion_directa" class="form-label">Monto de la Cotizaci贸n (CLP)</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="monto_cotizacion_directa" name="monto_cotizacion" min="1000" placeholder="Ej: 85000" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="detalle_cotizacion_directa" class="form-label">Detalle/Observaciones (Opcional)</label>
                                <textarea class="form-control" id="detalle_cotizacion_directa" name="detalle_cotizacion" rows="2"></textarea>
                            </div>

                            <button type="submit" class="btn btn-info mt-3 w-100 text-white">
                                <i class="fas fa-paper-plane me-1"></i> Enviar Cotizaci贸n y Poner en Espera
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            {# ========================================================== #}
            {# 2. RECHAZAR SOLICITUD #}
            {# ========================================================== #}
            <div class="col-lg-6 mb-4">
                <div class="card bg-dark-subtle text-white border-danger shadow-lg h-100">
                    <div class="card-header bg-danger fw-bold">
                        <i class="fas fa-times me-1"></i> 2. Rechazar Solicitud
                    </div>
                    <div class="card-body">
                        <p>Rechaza la solicitud si no puede ser procesada por Optifire. Esta acci贸n es irreversible.</p>
                        <form method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="rechazar">

                            <div class="mb-3">
                                <label for="motivo_rechazo" class="form-label">Motivo del Rechazo</label>
                                <textarea class="form-control" id="motivo_rechazo" name="motivo_rechazo" rows="6" required></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-danger w-100 mt-auto">
                                <i class="fas fa-times-circle me-1"></i> Rechazar Solicitud
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    {% elif solicitud.estado == 'COTIZANDO' %}
        {# ESTADO: COTIZANDO - Esperando la aprobaci贸n del cliente #}
        <div class="alert alert-info text-dark shadow-sm">
            <h4 class="alert-heading"><i class="fas fa-hourglass-half me-2"></i> En Espera de Aprobaci贸n del Cliente</h4>
            <p>Se ha enviado la cotizaci贸n por **${{ solicitud.monto_cotizacion|floatformat:0 }} CLP** al cliente. El cliente debe aprobar este monto antes de que se genere la orden de trabajo.
            </p>
             <p>T茅cnico Pre-Asignado: **{{ solicitud.tecnico_asignado.get_full_name|default:solicitud.tecnico_asignado.username }}**</p>
        </div>

    {% elif solicitud.estado == 'APROBADA' or solicitud.estado == 'ASIGNADA' or solicitud.estado == 'EN_CURSO' or solicitud.estado == 'COMPLETADA' %}
        {# ESTADOS DE TRABAJO EN CURSO #}
        <div class="alert alert-success text-dark shadow-sm">
            <h4 class="alert-heading"><i class="fas fa-check-circle me-2"></i> Orden de Trabajo Aprobada ({{ solicitud.get_estado_display }})</h4>
            <p>Esta solicitud ya fue aprobada por el cliente y es una Orden de Trabajo en curso.
            {% if solicitud.tecnico_asignado %}
                <p class="mt-2 mb-0">T茅cnico Asignado: <strong>{{ solicitud.tecnico_asignado.get_full_name|default:solicitud.tecnico_asignado.username }}</strong></p>
                {% if solicitud.fecha_trabajo %}<p>Fecha de Trabajo: <strong>{{ solicitud.fecha_trabajo|date:"d/m/Y" }}</strong></p>{% endif %}
            {% endif %}
        </div>

    {% else %}
        {# OTROS ESTADOS (RECHAZADA, ANULADA) #}
        <div class="alert alert-secondary text-dark shadow-sm">
            <i class="fas fa-info-circle me-2"></i> Esta solicitud ya ha sido **{{ solicitud.get_estado_display }}**. No se pueden realizar m谩s acciones en este panel.
        </div>
    {% endif %}

{% endblock dashboard_content %}