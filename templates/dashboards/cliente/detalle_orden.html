{% extends "base_dashboard.html" %}
{% load static %}

{% block title %}Detalle Orden #{{ solicitud.id }} | Optifire{% endblock %}

{# 1. Menú Lateral #}
{% block dashboard_menu %}
    {% include "includes/cliente_menu.html" %}
{% endblock dashboard_menu %}

{# 2. Contenido Principal #}
{% block dashboard_content %}
<div class="container-fluid px-0">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 text-dark fw-bold mb-1">
                <i class="fas fa-clipboard-list me-2"></i>Detalle de Orden de Trabajo #{{ solicitud.id }}
            </h1>
            <p class="text-muted mb-0">Revisa el estado, el historial y la evidencia de tu solicitud.</p>
        </div>
        <a href="{% url 'dashboard_cliente' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i> Volver a Mis Órdenes
        </a>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 border-end">
                    <h5 class="text-primary mb-3">Información General de la Solicitud</h5>
                    
                    <p class="mb-2"><strong>Estado Actual:</strong> 
                        <span class="badge rounded-pill fs-6
                            {% if solicitud.estado == 'PENDIENTE' %} bg-warning text-dark
                            {% elif solicitud.estado == 'APROBADA' %} bg-primary
                            {% elif solicitud.estado == 'COMPLETADA' %} bg-success
                            {% elif solicitud.estado == 'RECHAZADA' %} bg-danger
                            {% else %} bg-secondary {% endif %}">
                            {{ solicitud.get_estado_display }}
                        </span>
                    </p>
                    <p class="mb-2"><strong>Fecha Solicitud:</strong> {{ solicitud.fecha_solicitud|date:"d M Y H:i" }}</p>
                    <p class="mb-2"><strong>Maquinaria/Activo:</strong> {{ solicitud.maquinaria }}</p>
                    <p class="mb-2"><strong>Ubicación:</strong> {{ solicitud.direccion }}</p>
                    
                    {% if solicitud.observaciones_cliente %}
                        <p class="mb-0 text-muted small fst-italic">"{{ solicitud.observaciones_cliente }}"</p>
                    {% endif %}
                </div>

                <div class="col-md-6 ps-md-4">
                    <h5 class="text-success mb-3">Detalles de la Inspección Asignada</h5>
                    
                    {% if inspeccion %}
                        <p class="mb-2"><strong>Nombre Inspección:</strong> {{ inspeccion.nombre_inspeccion }}</p>
                        <p class="mb-2"><strong>Técnico Asignado:</strong> {{ inspeccion.tecnico.get_full_name|default:inspeccion.tecnico.username }}</p>
                        <p class="mb-2"><strong>Fecha Inicio:</strong> 
                            {% if inspeccion.fecha_programada %}
                                {{ inspeccion.fecha_programada|date:"d M Y" }}
                            {% else %}
                                <span class="text-muted">Por definir</span>
                            {% endif %}
                        </p>
                        
                        {% if inspeccion.estado != 'COMPLETADA' %}
                            <div class="alert alert-warning py-2 px-3 mt-3 border-0 small">
                                <i class="fas fa-clock me-1"></i> Inspección en curso o pendiente de finalizar por el técnico.
                            </div>
                        {% else %}
                            <div class="alert alert-success py-2 px-3 mt-3 border-0 small">
                                <i class="fas fa-check-circle me-1"></i> Inspección finalizada el {{ inspeccion.fecha_finalizacion|date:"d M Y" }}.
                            </div>
                        {% endif %}

                    {% else %}
                        <div class="alert alert-info border-0">
                            <i class="fas fa-info-circle me-2"></i> Aún no se ha asignado una inspección técnica a esta solicitud.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if tareas %}
    <div class="card shadow-sm border-0">
        <div class="card-body">
            <h5 class="text-primary mb-3">Checklist de Tareas Realizadas</h5>
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th width="5%" class="text-center">#</th>
                            <th width="35%">Descripción de la Tarea</th>
                            <th width="15%">Estado</th>
                            <th width="30%">Observación del Técnico</th>
                            <th width="15%" class="text-center">Evidencia</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tarea in tareas %}
                        <tr>
                            <td class="text-center fw-bold">{{ forloop.counter }}</td>
                            <td>{{ tarea.descripcion }}</td>
                            <td>
                                {% if tarea.estado == 'B' %}
                                    <span class="badge bg-success w-100">Bueno</span>
                                {% elif tarea.estado == 'M' %}
                                    <span class="badge bg-danger w-100">Malo</span>
                                {% elif tarea.estado == 'N/A' %}
                                    <span class="badge bg-secondary w-100">N/A</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark w-100">Pendiente</span>
                                {% endif %}
                            </td>
                            <td class="small text-muted">{{ tarea.observacion|default:"-" }}</td>
                            
                            <td class="text-center">
                                {% if tarea.imagen_evidencia %}
                                    <a href="{{ tarea.imagen_evidencia.url }}" target="_blank" class="btn btn-sm btn-outline-primary fw-bold">
                                        <i class="fas fa-image me-1"></i> Ver Foto
                                    </a>
                                {% else %}
                                    <span class="text-muted small opacity-50">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if inspeccion.estado == 'COMPLETADA' %}
                <div class="mt-4 text-end pt-3 border-top">
                    <a href="{% url 'descargar_acta' inspeccion.pk %}" class="btn btn-danger btn-lg shadow-sm" target="_blank">
                        <i class="fas fa-file-pdf me-2"></i> Descargar Acta PDF
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
    {% endif %} {# <--- ESTE ES EL ENDIF QUE FALTABA #}

</div>
{% endblock dashboard_content %}