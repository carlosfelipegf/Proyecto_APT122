{% extends 'base.html' %} 
{% load crispy_forms_tags %}
{% block title %}Nueva Inspección{% endblock %}

{% block content %}
    <div class="container mt-5">
        <h1>Crear Nueva Inspección</h1>
        <p>Utiliza el siguiente formulario para ingresar los puntos de control.</p>

        <form method="post">
            {% csrf_token %}

            <div class="mb-3">
                <label for="id_nombre_inspeccion" class="form-label">Nombre de la Inspección</label>
                <input type="text" name="nombre_inspeccion" id="id_nombre_inspeccion" class="form-control" required>
            </div>
            
            <hr>
            
            <h3>Puntos de Control / Tareas</h3>
            
            {{ formset.management_form }}
            
            <div id="tarea-container">
                {% for form in formset %}
                <div class="row mb-3 p-2 border rounded tarea-item">
                    
                    <div class="col-md-5">
                        <label class="form-label">Punto a Revisar:</label>
                        {{ form.descripcion }}
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">Estado:</label>
                        {{ form.estado }}
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label">Observación:</label>
                        {{ form.observacion }}
                    </div>
                    
                    {% for hidden in form.hidden_fields %}
                        {{ hidden }}
                    {% endfor %}
                </div>
                {% endfor %}
            </div>

            <button type="button" class="btn btn-secondary mb-4" id="add-tarea-btn">
                <i class="fas fa-plus"></i> Añadir más tareas
            </button>
            
            <hr>

            <button type="submit" name="guardar_borrador" class="btn btn-warning">
                <i class="fas fa-save"></i> Guardar como Borrador (Pendiente)
            </button>
            
            <button type="submit" name="terminar_inspeccion" class="btn btn-success">
                <i class="fas fa-check-circle"></i> Terminar Inspección
            </button>

            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">Cancelar</a>

        </form>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('tarea-container');
            const addButton = document.getElementById('add-tarea-btn');
            const totalForms = document.getElementById('id_form-TOTAL_FORMS');
            
            // Función para clonar la última fila de tareas
            function cloneMore(selector) {
                const newElement = document.querySelector(selector).cloneNode(true);
                const formRegex = new RegExp('form-(\\d+)-', 'g');
                
                // Obtener el número actual de formularios
                let formNum = parseInt(totalForms.value);
                
                // Reemplazar los IDs y nombres para que Django lo reconozca
                newElement.innerHTML = newElement.innerHTML.replace(formRegex, `form-${formNum}-`);
                container.appendChild(newElement);
                
                // Actualizar el conteo total de formularios
                totalForms.value = formNum + 1;
            }
            
            // Adjuntar el evento al botón
            addButton.addEventListener('click', function() {
                // Clonamos la última tarea existente (o la primera si es el caso)
                cloneMore('.tarea-item:last-child');
            });
            
            // Opcional: limpiar los campos clonados si no quieres que retengan el valor anterior
            // Esto es más complejo, pero es una buena práctica para formularios dinámicos.
        });
    </script>
    
{% endblock %}